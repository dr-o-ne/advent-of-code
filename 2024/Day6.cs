namespace AdventOfCode._2024;

public sealed class Day6
{
    internal enum Direction
    {
        Top,
        Right,
        Bottom,
        Left,
    }

    internal sealed class Matrix
    {
        private const char IsVisited = '1';
        private const char IsBlocked = '#';
        private const char IsStartedPosition = '^';

        private readonly char[,] _inner;
        private Direction _direction;
        private int _x;
        private int _y;
        private int _maxMoves;

        public Matrix(char[,] matrix)
        {
            _inner = new char[matrix.GetLength(0), matrix.GetLength(1)];

            for (int y = 0; y < matrix.GetLength(0); y++)
            {
                for (int x = 0; x < matrix.GetLength(1); x++)
                {
                    _inner[y, x] = matrix[y, x];
                    if (_inner[y, x] == IsStartedPosition)
                    {
                        _y = y;
                        _x = x;
                    }
                }
            }

            _direction = Direction.Top;
            _inner[_y, _x] = IsVisited;
            _maxMoves = _inner.GetLength(0) * _inner.GetLength(1) * 4;
        }

        public bool MoveNext()
        {
            switch (_direction)
            {
                case Direction.Top:
                    if (_y == 0) return false;
                    if (_inner[_y - 1, _x] == IsBlocked)
                    {
                        _direction = Direction.Right;
                        return MoveNext();
                    }
                    else
                        _y--;
                    break;
                case Direction.Right:
                    if (_x == _inner.GetLength(1) - 1) return false;
                    if (_inner[_y, _x + 1] == IsBlocked)
                    {
                        _direction = Direction.Bottom;
                        return MoveNext();
                    }
                    else
                        _x++;
                    break;
                case Direction.Bottom:
                    if (_y == _inner.GetLength(0) - 1) return false;
                    if (_inner[_y + 1, _x] == IsBlocked)
                    {
                        _direction = Direction.Left;
                        return MoveNext();
                    }
                    else
                        _y++;
                    break;
                case Direction.Left:
                    if (_x == 0) return false;
                    if (_inner[_y, _x - 1] == IsBlocked)
                    {
                        _direction = Direction.Top;
                        return MoveNext();
                    }
                    else
                        _x--;
                    break;
                default:
                    throw null;
            }

            _inner[_y, _x] = IsVisited;

            return true;
        }

        public List<(int, int)> GetVisitedCells()
        {
            var result = new List<(int, int)>();
            for (int y = 0; y < _inner.GetLength(0); y++)
                for (int x = 0; x < _inner.GetLength(1); x++)
                    if (_inner[y, x] == IsVisited)
                        result.Add((y, x));

            return result;
        }

        public int GetMaxPossibleMoveCount() =>
            _inner.GetLength(0) * _inner.GetLength(1) * 4;

        public void BlockCell(int y, int x) =>
            _inner[y, x] = IsBlocked;
    }

    public int Solve1(string input)
    {
        var matrix = new Matrix(Utils.ParseMatrix<char>(input));

        TryTraverse(matrix);

        return matrix.GetVisitedCells().Count;
    }

    public int Solve2(string input)
    {
        var data = Utils.ParseMatrix<char>(input);

        var result = 0;

        var matrix = new Matrix(data);
        TryTraverse(matrix);
        var visited = matrix.GetVisitedCells();

        foreach ((var y, var x) in visited)
        {
            matrix = new Matrix(data);
            matrix.BlockCell(y, x);

            if (!TryTraverse(matrix))
                result++;
        }

        return result;
    }

    private static bool TryTraverse(Matrix matrix)
    {
        for (int i = 0; i < matrix.GetMaxPossibleMoveCount(); i++)
        {
            if (!matrix.MoveNext())
                return true;
        }

        return false;
    }

    [Fact]
    public void Test1() => Assert.Equal(5153, Solve1(Input));

    [Fact]
    public void Test2() => Assert.Equal(1711, Solve2(Input));

    private const string Input = @".......................#...................#....#..#......#.................#.#..#........................#.#..............#.....#
................#.#.......#..#.......#.................................................................................#.##.......
............#..............#......................#...#.....#...#..........##.........#.....#.....................................
..#...#......................................#............................#..................#..........#..#......................
....#........#.#....................#..........#.....#.............#..#............................#..................#......#....
..........................................................#................#............................................#.........
..#............................#.....#...........................#...........#........##...........................#..#...........
.....................#...........................#.#..............#......................................#.........#....#.....#...
.#...#.#.................#....................#...............................................................#.#..........#......
....#....................................#...........................................#.....#..........#...........................
.......................#..........#..............#......#....#.......#........................................#.#.................
......#...........................................................#...#............#.................#............................
.......#.................#..#.....................#...............................................................................
..............#....................#.#..........#........#......#................#.................#..........#...................
#.#.......................................#.........................#...................................#.........................
...#.........................................................................................#................#..................#
#.....#....#............................................................#.........................#..................#.#..........
.#.....#.#.......#.#..................#.#......................#.......#.....#..#..................##.....#.......#...#...........
....#.........#.................................#..........#........#...............#................#...................#....#...
.................#...............#...#.................#.................................................#........................
....#...#...............................#..................................................#..........#................#.....#....
...........#........#....#.......#...#..........#...............#.....#.....#.....#..........#....................................
............#.........#.................#................#.................#.#..................................................#.
............#......................................#...................................................................#..........
...........#....#.....................................................................................#............#..........#...
..........#........................................#.............#.................#........................#..#.......#........#.
......#.............................#.................##..................................#.....................#.................
.#.................................#.............................................#.................##.....#..............#......#.
.........................#..............................#..........#...........#....#................#......................#.....
.......#...................#......##........................#.........#...........................................................
......................................................................##...........#................#.............................
....#...................................##...............................................#........................................
...##.....#..#........#.................#..............................................................#..........................
........##......#....................#..............................#......................#...................#..................
.........................................................#.......................................................#.#..............
..........#.............................#.........#...............#................#.#.........#..........................#.#.....
....................#...................#..#.......................................................#..........#...............#...
...........................................................#........................#.........#........#..........................
.......#..............#......#.................................#...................##...........................#.........#.......
#...#...............................................................................................................#.............
................................#..#....#............#...........#..................#.............................#...............
....................#..............#.........#.................................#.............#..##................................
#...#..................................................................................#.....#...........#........................
........#...........#........#...#..................#.....#....#.........#.........................#...........................#..
.............#...#...................................................................#...........#................................
.............#........................................#...#.............#..............................#..#.........#.............
...#.................................................................................#.............#..........................##..
...#..............................................................................................................................
................#.........#..................................#...................#................................................
...#................#...#.#.....................#...........#..................................#........#....#......#.............
..........................#.....................#..#...................................##........................................#
#........................#...............................................#........#..#..........#...........................#.....
.#............#.#..............................................................#...........#......................................
......#..................................................................#.......#..............................#...#....#........
........#........................#.........#.............#.....#..................................................................
...............................................................................#...........................................#......
........................#..................................#.....................................................#................
............................................................#..........................#.................#.......................#
.....................#..#.........................#..............#.............................#........#..............##......#..
.....................#.................................................#.......#............#........................#.......#....
......................#.....................................................#......#............................#.................
................................................................#...#..##..#.....................................#...............#
..............#..............................................................................................#....................
............................................#......#..........#...............................................................#...
....#.................................#..................................................................#..........##..#.........
............#.....#................................................................................#..........#.........#.........
.....................#......................................#.........#....................................................#....#.
.........................#...............................#...............................#....................#...................
.#.....................#.#.......................................#....#...........#.......................#.......................
.....................................................#.#..#......................................................................#
#..........#..........................#............................#.............#..................#.............#...........#...
........#.........................................................................................................................
..........#.............#.........................................#................................................#..............
...........#................................#.................#...........................#.............................#.........
..................#.........................................#.#..................#...#...........#.......#..#.....................
........................................................#...#.......................................................#.............
.........................................................................#.......#..#.....#.......................................
............#..............................................................#.........#..............#.............#...............
#...#..........................................#...........#.....#.....................................#...............#..........
...........................#............#.........................................................................................
...#..........................................#.......................................................................#...........
..............#......#.....#.....................#..........................#.....................................................
.........................#....#...................#...#.......#..............................#........................#...........
.............................#............^.#................................................#......#..#.#...........#............
....................................................................................#...#.#...................................#...
.......................#..............................##..............................................#...........................
......................#...................................................#..........................................#............
......#........................................................................#.....................................#............
.......................#.............................#........................#...........#...........#............#...........#..
....#...............#..#......#....#..................#.............#.......#...............#.......................#.............
............#...#..................#..............................................................................................
....#.......#.................#.......................................................#..#......#.................................
.........#......#..........#......................#.....................#..................#.#....................................
...............##.......................................................#...#.............................#.......#...............
........................................................##...................#...#............#......#............................
...........#...#..............#.............................................................#...................#............#....
...............................................#.....#.....#......................................................................
.#....................#...#........#....................#.#.........#..........#................................#................#
.............#.....#..#....................................#.#...........#.................................................#..#.#.
......#.....................................#....................................................................#................
............................................................##......#.....................#.......#.....................#...#.....
.#.......#......................#.................................................................................................
................#....#......................#.........#...................#........#.......##.....#...............................
..#....#....................#............................................................#.#......#............#.....#.#....#.....
.................................#.................................................#.......#......................................
..................#...........#....#.....................#......#...............#..................#....................##........
.##...............................................#............#...........................#......................................
.............#...........#...........................#..#.......#...#..........#......................#..........#................
.......#...................................#.................#....#..............................................................#
........#....................................................#.................#.....#.........#.#................................
................#.................................#.....................#.....#.....#............................##...............
..............................................##.................#..##........#...........#............#..........................
....#......................................#...............................................................................#......
..#..............#.#................#..#..............#.......................................#.#.......#..............#......#..#
.....#..............................................................................................................#.......#.....
..#.......#.#..........#.......#..................................#..........#.......#.................#...........#...........#..
...............#.....#................#............#................#............#.....#.#........#...............................
....#.....................#................#.....................................#......................#.#.......#....#..........
........#...............#...#.....................................................#........#.........#.........#..................
...#......#..........................#.....#..........................##.......#....#.............................................
.............#................................#............................#.....#.......#......#................................#
.......................#............#..........................#..................................................................
.................................................#..............#...#...........................#.................................
......#...................#..............................................................................................#....#..#
....................................#......#.....................#..............#.......#...................#.....................
............#...................................#...........#........#........#...........................................##......
#...........#..........................#....................................#.........#................................#..........
......##..#...............................................................#...............................#.........#.............
.......................#.....#.........................#...#.........................#.....#..........#.#...#.....................
.......................#..#.....#.....#..........................#.........#.....#....................#.....#....................#";
}
